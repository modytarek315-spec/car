<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Car House ðŸš—</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

    <!-- Supabase & Services -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/services/auth.service.js"></script>
    <script src="js/services/orders.service.js"></script>
    <script src="js/services/bookings.service.js"></script>
    <script src="js/services/favorites.service.js"></script>
    <script src="js/app.integration.js" defer></script>
</head>

<body class="bg-[#1A1A1A] text-white">
    <header class="header">
        <div class="header-top">
            <div class="logo-section">
                <a href="index.html" style="display: flex; align-items: center; gap: 12px; text-decoration: none;">
                    <img src="logo.png" alt="Car House Logo" style="height: 50px; width: auto; object-fit: contain;">
                    <div class="logo-text">
                        <h1 id="store-name" style="margin: 0; font-size: 24px; color: white;">Car House</h1>
                        <p id="store-tagline" style="margin: 0; font-size: 12px; opacity: 0.8; color: #ccc;">Quality
                            Parts for Your Vehicle</p>
                    </div>
                </a>
            </div>
            <div class="header-actions">
                <button onclick="window.AuthService.logout().then(() => window.location.href='index.html')"
                    class="logout-btn-alt">Logout</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-links">
            <li><a href="index.html"><button>Home</button></a></li>
            <li><a href="index.html"><button>Shop</button></a></li>
            <li><a href="index.html?cat=service"><button>Services</button></a></li>
        </ul>
    </nav>

    <div class="container mx-auto px-4 py-10">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar -->
            <aside class="w-full lg:w-1/4">
                <div class="bg-gray-800 rounded-2xl border border-gray-700 p-6 shadow-xl">
                    <div class="text-center mb-8 relative group">
                        <div id="avatar-container" class="relative inline-block cursor-pointer">
                            <div id="user-avatar-wrapper"
                                class="w-24 h-24 bg-yellow-500 rounded-full mx-auto flex items-center justify-center mb-4 text-black text-3xl font-bold border-4 border-gray-700 overflow-hidden">
                                <span id="user-initials">U</span>
                                <img id="user-avatar" class="hidden w-full h-full object-cover" src=""
                                    alt="Profile Photo">
                            </div>
                            <div
                                class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            <input type="file" id="avatar-input" class="hidden" accept="image/*">
                        </div>
                        <h3 id="display-name" class="text-xl font-bold truncate">User Name</h3>
                        <p id="display-email" class="text-gray-400 text-sm truncate">email@example.com</p>
                    </div>

                    <nav class="space-y-2">
                        <button data-tab="profile-tab"
                            class="tab-btn active w-full text-left px-4 py-3 rounded-lg bg-yellow-500 text-black font-bold transition">
                            Profile Overview
                        </button>
                        <button data-tab="orders-tab"
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition">
                            Order History
                        </button>
                        <button data-tab="bookings-tab"
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition">
                            Service Bookings
                        </button>
                        <button data-tab="favorites-tab"
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg text-gray-300 hover:bg-gray-700 transition">
                            My Favorites
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1">
                <!-- Profile Tab -->
                <div id="profile-tab" class="tab-content transition-all duration-300">
                    <div class="bg-gray-800 rounded-2xl border border-gray-700 p-8 shadow-xl">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            Account Settings
                        </h2>
                        <form id="profile-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Full Name</label>
                                    <input type="text" id="full-name"
                                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Phone Number</label>
                                    <input type="tel" id="phone"
                                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500 text-white">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Residential
                                        Address</label>
                                    <textarea id="address" rows="3"
                                        class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:border-yellow-500 text-white"></textarea>
                                </div>
                            </div>
                            <button type="submit"
                                class="bg-yellow-500 text-black font-bold px-8 py-3 rounded-lg hover:bg-yellow-400 transition shadow-lg">
                                Update Profile
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="orders-tab" class="tab-content hidden transition-all duration-300">
                    <div class="bg-gray-800 rounded-2xl border border-gray-700 p-8 shadow-xl">
                        <h2 class="text-2xl font-bold mb-6">Order History</h2>
                        <div id="orders-list" class="space-y-4">
                            <!-- Orders will be loaded here -->
                            <p class="text-gray-500">Retrieving your orders...</p>
                        </div>
                    </div>
                </div>

                <!-- Bookings Tab -->
                <div id="bookings-tab" class="tab-content hidden transition-all duration-300">
                    <div class="bg-gray-800 rounded-2xl border border-gray-700 p-8 shadow-xl">
                        <h2 class="text-2xl font-bold mb-6">Service Appointments</h2>
                        <div id="bookings-list" class="space-y-4">
                            <!-- Bookings will be loaded here -->
                            <p class="text-gray-500">Loading your scheduled services...</p>
                        </div>
                    </div>
                </div>

                <!-- Favorites Tab -->
                <div id="favorites-tab" class="tab-content hidden transition-all duration-300">
                    <div class="bg-gray-800 rounded-2xl border border-gray-700 p-8 shadow-xl">
                        <h2 class="text-2xl font-bold mb-6">Saved Favorites</h2>
                        <div id="favorites-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Favorites will be loaded here -->
                            <p class="text-gray-500">Checking your wish list...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Tab Switching logic
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => {
                        t.classList.remove('active', 'bg-yellow-500', 'text-black', 'font-bold');
                        t.classList.add('text-gray-300', 'hover:bg-gray-700');
                    });
                    contents.forEach(c => c.classList.add('hidden'));

                    tab.classList.add('active', 'bg-yellow-500', 'text-black', 'font-bold');
                    tab.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    document.getElementById(tab.dataset.tab).classList.remove('hidden');

                    if (tab.dataset.tab === 'favorites-tab') renderFavoritesListing();
                });
            });

            // Load User Data
            const user = await window.CarHouseSupabase.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('display-email').textContent = user.email;
            document.getElementById('user-initials').textContent = user.email.charAt(0).toUpperCase();

            const { profile } = await window.AuthService.getProfile();
            if (profile) {
                document.getElementById('full-name').value = profile.full_name || '';
                document.getElementById('display-name').textContent = profile.full_name || user.email.split('@')[0];
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('address').value = profile.address || '';
                document.getElementById('user-initials').textContent = (profile.full_name || user.email).charAt(0).toUpperCase();

                // Handle Display Photo
                if (profile.avatar_url) {
                    const avatarImg = document.getElementById('user-avatar');
                    const initials = document.getElementById('user-initials');
                    avatarImg.src = profile.avatar_url;
                    avatarImg.classList.remove('hidden');
                    initials.classList.add('hidden');
                }
            }

            // Image Change Functionality
            const avatarContainer = document.getElementById('avatar-container');
            const avatarInput = document.getElementById('avatar-input');

            avatarContainer.onclick = () => avatarInput.click();

            avatarInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Simple preview
                const reader = new FileReader();
                reader.onload = (event) => {
                    const avatarImg = document.getElementById('user-avatar');
                    const initials = document.getElementById('user-initials');
                    avatarImg.src = event.target.result;
                    avatarImg.classList.remove('hidden');
                    initials.classList.add('hidden');
                };
                reader.readAsDataURL(file);

                // Upload to Supabase
                const res = await window.AuthService.uploadAvatar(file);
                if (res.success) {
                    window.CarHouseSupabase.showToast('Profile photo updated!');
                } else {
                    window.CarHouseSupabase.showToast('Failed to upload photo: ' + res.error, '#e74c3c');
                }
            };

            // Load History Items
            loadOrders();
            loadBookings();
        });

        async function loadOrders() {
            const container = document.getElementById('orders-list');
            try {
                const { orders } = await window.OrdersService.getOrderHistory();
                if (!orders || orders.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-500">No orders found yet. Start shopping!</div>';
                    return;
                }

                container.innerHTML = orders.map(order => `
          <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 flex justify-between items-center group hover:border-yellow-500 transition">
            <div>
              <div class="text-sm text-gray-500">Order #${order.id.slice(0, 8)}</div>
              <div class="font-bold text-lg">${order.total_amount.toFixed(2)} EGP</div>
              <div class="text-xs text-gray-500">${new Date(order.created_at).toLocaleDateString()}</div>
            </div>
            <div class="text-right">
              <span class="px-3 py-1 rounded-full text-xs font-bold uppercase" style="background:${window.OrdersService.getStatusDisplay(order.status).color}22; color:${window.OrdersService.getStatusDisplay(order.status).color}">
                ${order.status}
              </span>
            </div>
          </div>
        `).join('');
            } catch (e) { container.innerHTML = '<p class="text-red-500">Failed to load orders.</p>'; }
        }

        async function loadBookings() {
            const container = document.getElementById('bookings-list');
            try {
                const { bookings } = await window.BookingsService.getBookingHistory();
                if (!bookings || bookings.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-gray-500">No service bookings found.</div>';
                    return;
                }

                container.innerHTML = bookings.map(booking => `
          <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 group hover:border-blue-500 transition">
            <div class="flex justify-between items-start mb-2">
              <div>
                <div class="font-bold text-blue-400">${booking.service_type_name || 'Vehicle Service'}</div>
                <div class="text-lg font-bold">${new Date(booking.scheduled_date).toLocaleDateString()} at ${booking.scheduled_time || '09:00'}</div>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-bold uppercase" style="background:${window.BookingsService.getStatusDisplay(booking.status).color}22; color:${window.BookingsService.getStatusDisplay(booking.status).color}">
                ${booking.status}
              </span>
            </div>
            <div class="text-sm text-gray-400">
              Vehicle: ${booking.vehicle_info.year} ${booking.vehicle_info.make} ${booking.vehicle_info.model}
            </div>
          </div>
        `).join('');
            } catch (e) { container.innerHTML = '<p class="text-red-500">Failed to load bookings.</p>'; }
        }

        async function renderFavoritesListing() {
            const container = document.getElementById('favorites-list');
            container.innerHTML = '<p class="text-gray-500">Loading your favorites...</p>';

            const { favorites } = await window.FavoritesService.getFavoritesWithDetails();
            if (!favorites || favorites.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">Your favorites list is empty.</div>';
                return;
            }

            container.innerHTML = favorites.map(fav => {
                const p = fav.product || {};
                const imageUrl = (p.images && p.images.length > 0) ? p.images[0].url : (p.image || 'https://via.placeholder.com/80');

                return `
                    <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 flex gap-4 items-center">
                      <img src="${imageUrl}" class="w-20 h-20 object-contain bg-black rounded-lg">
                      <div class="flex-1">
                        <h4 class="font-bold text-white line-clamp-1">${p.name || 'Unknown Product'}</h4>
                        <p class="text-yellow-500 font-bold">${(p.price || 0).toFixed(2)} EGP</p>
                        <div class="flex gap-2 mt-2">
                           <button onclick="moveToCart('${fav.product_id}')" class="text-xs bg-gray-700 hover:bg-yellow-500 hover:text-black px-3 py-1 rounded transition">Add to Cart</button>
                           <button onclick="removeFavorite('${fav.product_id}')" class="text-xs text-red-400 hover:bg-red-900/30 px-3 py-1 rounded transition">Remove</button>
                        </div>
                      </div>
                    </div>
                `;
            }).join('');
        }

        async function moveToCart(pid) {
            const res = await window.FavoritesService.moveToCart(pid);
            if (res.success) {
                window.CarHouseSupabase.showToast('Item moved to cart!');
                renderFavoritesListing();
            }
        }

        async function removeFavorite(pid) {
            const res = await window.FavoritesService.removeFavorite(pid);
            if (res.success) {
                window.CarHouseSupabase.showToast('Removed from favorites');
                renderFavoritesListing();
            } else {
                window.CarHouseSupabase.showToast('Failed to remove: ' + res.error, '#e74c3c');
            }
        }

        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('full-name').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            const res = await window.AuthService.updateProfile({ full_name: fullName, phone, address });
            if (res.success) {
                window.CarHouseSupabase.showToast('Profile updated successfully!');
                document.getElementById('display-name').textContent = fullName;
            } else {
                window.CarHouseSupabase.showToast('Failed to update: ' + res.error, '#e74c3c');
            }
        };
    </script>
</body>

</html>